From 6a7f215e02cc17e3939949deb6d19421188830d4 Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Fri, 16 Jul 2010 22:10:18 +0100
Subject: [PATCH] strace: print usb traffic and add hex output pretty printing

Based on a patch from http://iki.fi/lindi/strace-4.5.8-usbdevfs.diff
---
 Makefile.am |    2 +-
 defs.h      |    1 +
 ioctl.c     |    2 ++
 3 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index c44762e..adb39dc 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -15,7 +15,7 @@ INCLUDES = -I$(srcdir)/$(OS)/$(ARCH) -I$(srcdir)/$(OS)
 strace_SOURCES = strace.c syscall.c count.c util.c desc.c file.c ipc.c \
 		 io.c ioctl.c mem.c net.c process.c bjm.c quota.c \
 		 resource.c signal.c sock.c system.c term.c time.c \
-		 proc.c scsi.c stream.c
+		 usbdevfs.c proc.c scsi.c stream.c
 noinst_HEADERS = defs.h
 
 EXTRA_DIST = $(man_MANS) errnoent.sh signalent.sh syscallent.sh ioctlsort.c \
diff --git a/defs.h b/defs.h
index 419b12e..30a1eec 100644
--- a/defs.h
+++ b/defs.h
@@ -558,6 +558,7 @@ extern int stream_ioctl(struct tcb *, int, int);
 #ifdef LINUX
 extern int rtc_ioctl(struct tcb *, long, long);
 extern int scsi_ioctl(struct tcb *, long, long);
+extern int usbdevfs_ioctl (struct tcb *, long, long);
 #endif
 
 extern int tv_nz(struct timeval *);
diff --git a/ioctl.c b/ioctl.c
index 906c71e..e75520c 100644
--- a/ioctl.c
+++ b/ioctl.c
@@ -154,6 +154,8 @@ long code, arg;
 		return rtc_ioctl(tcp, code, arg);
 	case 0x22:
 		return scsi_ioctl(tcp, code, arg);
+	case 0x55:
+		return usbdevfs_ioctl(tcp, code, arg);
 #endif
 	default:
 		break;
-- 
1.7.1.1

